stages:
  - build-x11-warrior
  - build-wayland-warrior
  - build-x11-thud
  - build-wayland-thud

before_script:
  - mkdir -p ~/yocto-chromium
  - cd ~/yocto-chromium
  - ulimit -n 4096
  - repo init -u https://gitlab.com/saavedra.pablo/meta-perf-browser.git -m $MANIFEST -b nightly
  - repo sync --force-sync
  - pushd sources/meta-browser
  - git remote remove tmp || true
  - git remote add tmp $CI_REPOSITORY_URL
  - git fetch tmp
  - git checkout $CI_COMMIT_SHA
  - popd
  - source setup-environment $SOURCE
  - rm -rf tmp

x11-raspberrypi3-clang-warrior:
  stage: build-x11-warrior
  tags:
    - meta-browser
  variables:
    MANIFEST: manifest-warrior.xml
    # setup-environment targetname machine distro bblayers presets --update-config
    SOURCE: ci-chromium-x11-raspberrypi3-clang-warrior raspberrypi3-mesa browsers clang clang --update-config
    BITBAKE_TARGET: chromium-x11
  script:
    - bitbake $BITBAKE_TARGET
  when: always
  after_script:
    - rm -rf ~/yocto-chromium/builds/ci-chromium-x11-raspberrypi3-clang-warrior/tmp/*

x11-intel-core-i7-64-clang-thud:
  stage: build-x11-thud
  tags:
    - meta-browser
  variables:
    MANIFEST: manifest-thud.xml
    # setup-environment targetname machine distro bblayers presets --update-config
    SOURCE: ci-chromium-x11-i7-64-clang-thud intel-corei7-64 browsers clang clang-thud --update-config
    BITBAKE_TARGET: chromium-x11
  script:
    - bitbake $BITBAKE_TARGET
  when: always
  after_script:
    - rm -rf ~/yocto-chromium/builds/ci-chromium-x11-i7-64-clang-thud/tmp/*

x11-intel-core2-32-clang-thud:
  stage: build-x11-thud
  tags:
    - meta-browser
  variables:
    MANIFEST: manifest-thud.xml
    # setup-environment targetname machine distro bblayers presets --update-config
    SOURCE: ci-chromium-x11-core2-clang-thud intel-core2-32 browsers clang clang-thud --update-config
    BITBAKE_TARGET: chromium-x11
  script:
    - bitbake $BITBAKE_TARGET
  when: always
  after_script:
    - rm -rf ~/yocto-chromium/builds/ci-chromium-x11-core2-clang-thud/tmp/*


#### Wayland

wayland-m3ulcb-clang-thud:
  stage: build-wayland-thud
  tags:
    - meta-browser
  variables:
    MANIFEST: manifest-thud.xml
    # setup-environment targetname machine distro bblayers presets --update-config
    SOURCE: ci-chromium-wayland-m3ulcb-clang-thud m3ulcb browsers m3ulcb m3ulcb-thud-clang --update-config
    BITBAKE_TARGET: chromium-ozone-wayland
  script:
    - bitbake $BITBAKE_TARGET
  when: always
  after_script:
    - rm -rf ~/yocto-chromium/builds/ci-chromium-wayland-m3ulcb-clang-thud/tmp/*

wayland-raspberrypi3-clang-warrior:
  stage: build-wayland-warrior
  tags:
    - meta-browser
  variables:
    MANIFEST: manifest-warrior.xml
    # setup-environment targetname machine distro bblayers presets --update-config
    SOURCE: ci-chromium-wayland-raspberrypi3-clang-warrior raspberrypi3-mesa browsers clang clang --update-config
    BITBAKE_TARGET: chromium-ozone-wayland
  script:
    - bitbake $BITBAKE_TARGET
  when: always
  after_script:
    - rm -rf ~/yocto-chromium/builds/ci-chromium-wayland-raspberrypi3-clang-warrior/tmp/*

wayland-qemuarm64-clang-thud:
  stage: build-wayland-thud
  tags:
    - meta-browser
  variables:
    MANIFEST: manifest-thud.xml
    # setup-environment targetname machine distro bblayers presets --update-config
    SOURCE: ci-chromium-wayland-qemuarm64-clang qemuarm64 browsers clang clang-thud --update-config
    BITBAKE_TARGET: chromium-ozone-wayland
  script:
    - bitbake $BITBAKE_TARGET
  when: always
  after_script:
    - rm -rf ~/yocto-chromium/builds/ci-chromium-wayland-qemuarm64-clang/tmp/*
